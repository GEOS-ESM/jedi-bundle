## Preparing the configuration

The jedi_bundle system is passed a configuration file when issuing any build commands. This file can be generated by issuing `jedi_bundle` without any arguments:

``` shell
jedi_bundle
```

After completion, the code will produce `build.yaml`, containing all the configuration options. See the section on [dynamic configuration options](dynamic_configuration_options.md) for a description of all the settings prescribed in `build.yaml`.

If `jedi_bundle` is being run on a recognized platform, `build.yaml` will be populated with platform specific defaults.

## Building the code

In order to build the JEDI code the arguments that are passed to `jedi_bundle` are as follows:

``` shell
jedi_bundle [tasks] build.yaml
```

The first argument is a list describing the tasks that are to be completed. The second argument points to the YAML configuration describing the options for the build.

The list of possible tasks are `clone`, `configure` and `make`. You can also specify `all`, meaning all three tasks. Not that the name of the tasks is case insensitive.

The tasks perform the following duties:

| Task    | Description |
| --------| ----------- |
|clone    | Clone the JEDI repos according the branch name and organisations specified in the configuration. |
|configure| Run the CMake (ecbuild) configure step. Also create shortcut modules file for later sourcing with the build.|
|make     | Run the parallel make step, i.e. make -j6. |


## Basic Examples

To generate the configuration :

``` shell
jedi_bundle
```

To run **All** tasks :

``` shell
jedi_bundle all build.yaml
```

To run **Clone** and **Configure**:

``` shell
jedi_bundle clone configure build.yaml
```

## Using Pinned Versions of JEDI Repositories

Running `jedi_bundle` will pull the latest commits from each JEDI repository's default branch. Since some JEDI repositories change frequently, we may want to work with a fixed set of commit hashes so that internal development is insulated from these continuous updates. A set of stable commit hashes for the JEDI repositories can be found in `src/jedi_bundle/config/pinned_versions.yaml`. These versions will be updated periodically by the Swell team. To build JEDI with these pinned versions, run the `jedi_bundle` command with the pinned versions flag:

``` shell
jedi_bundle --pinned_versions
```

or, you can use option

``` shell
jedi_bundle -pv
```

After running `jedi_bundle` with the pinned versions option, you will see a list of `pinned versions` in the auto-generated `build.yaml` file appended at the end, as such:

```yaml
# build.yaml
# Previous sections remain the same
pinned_versions:
- jedicmake:
    branch: 40d521f9a2d796fcbc6234d77abceeffefb8eb7f
    commit: true
- oops:
    branch: e6485c0a659103f0daa2b7e2cece39a15bfb0d60
    commit: true
- saber:
    branch: e93b14ff97acc70cdbb6bdd57620da2cc81c5eb0
    commit: true
- ioda:
    branch: c7b8760fc187a9eafb72a466d16fdee284912377
    commit: true

```

Then, you can run `clone`, `configure`, `make`, or `all` commands as normal.


### Updating the Commit Hashes

If you would like to generate a set of commit hashes for a day other than what is in `src/jedi_bundle/config/pinned_versions.yaml`, you may do so by running the `jedi_bundle_update_hash` command with a date in the format YYYY-MM-DD:

``` shell
jedi_bundle_update_hash 2024-05-14
```

This will update the `pinned_versions.yaml` file in your `jedi_bundle` build with commit hashes that are the latest before the provided date. Then, you can run `jedi_bundle -pv` to see the updated hashes in the `build.yaml` file. 
